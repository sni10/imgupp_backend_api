# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Обзор проекта

Это система загрузки и управления изображениями с Django бэкендом и Vue.js фронтендом. Проект использует гибридную архитектуру с Django REST API и FastAPI эндпоинтами для обработки изображений.

### Компоненты архитектуры

- **Бэкенд**: Django 5.0.6 с Django REST Framework
- **Фронтенд**: Vue 3 с Vuetify UI фреймворком
- **Базы данных**: PostgreSQL (основная), MongoDB (дополнительная), Redis (кэширование/сессии)
- **Обработка изображений**: Кастомное приложение photomanager с управлением галереями и профилями
- **Аутентификация**: JWT-аутентификация с djangorestframework-simplejwt
- **Развертывание**: Docker контейнеры с Kubernetes манифестами

### Основные Django приложения

- `photomanager/`: Загрузка изображений, управление галереями, генерация миниатюр
- `users/`: Управление пользователями, планы подписок, аутентификация
- `linkmanager/`: Функциональность управления URL/ссылками
- `tools/`: Утилиты для баз данных и вспомогательные функции

## Команды разработки

### Django бэкенд (из директории /imgupp_root)

**Локальная разработка:**
```bash
python manage.py runserver 0.0.0.0:8000
python manage.py migrate
python manage.py createsuperuser
python manage.py test
```

**Docker разработка:**
```bash
docker-compose up django  # Запуск только Django сервиса
docker-compose up         # Запуск всех сервисов
```

**Альтернативный FastAPI:**
```bash
python main.py  # Запуск FastAPI сервера с photomanager эндпоинтами
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### Vue.js фронтенд (из директории /vue-app-front)

```bash
npm run serve    # Сервер разработки на порту 8080
npm run build    # Продакшн сборка
npm run lint     # Проверка ESLint
```

### Операции с базами данных

Требуемые переменные окружения для подключения к базам данных:
- `DB_NAME`, `DB_USER`, `DB_PASSWORD`, `DB_HOST`, `DB_PORT` (PostgreSQL)
- `MONGO_DB_NAME`, `MONGO_DB_HOST`, `MONGO_DB_PORT` (MongoDB)

## Ключевые архитектурные паттерны

### Двойной API дизайн
Проект поддерживает как Django REST Framework, так и FastAPI эндпоинты:
- Django представления в файлах `*/views.py`
- FastAPI маршруты в `photomanager/api.py` интегрированы через `main.py`

### Пайплайн обработки изображений
- Оригинальные изображения хранятся в `media/origins/galleries/`
- Обработанные изображения в `media/cache/galleries/` и `media/processed/`
- Автоматическая генерация миниатюр с настраиваемыми размерами (настройки: `CACHE_THUMB_SIZE`, `CACHE_IMG_SIZE`)

### Настройка мультибазы
- Основная PostgreSQL база данных для Django моделей
- MongoDB для дополнительного хранения документов
- Redis для хранения сессий и кэширования
- Тестовое окружение автоматически переключается на SQLite

### Аутентификация и сессии
- JWT токены для API аутентификации
- Сессии на основе Redis с таймаутом 15 минут
- CORS настроен для коммуникации с фронтендом

### Инфраструктура развертывания
- Докеризация с базовым образом Miniconda
- Kubernetes манифесты в `/k8s_manifests/` для продакшн развертывания
- Балансировка нагрузки Nginx и обслуживание статических файлов
- Отдельные пространства имен для разных окружений

## Конфигурация для разных окружений

Настройки автоматически определяют тестовые окружения и переключаются на облегченные бэкенды (SQLite, локальный кэш памяти), чтобы избежать зависимостей от внешних сервисов во время тестирования.

## Управление медиа

Изображения организованы по UUID галереи в структуре директории media. Система автоматически генерирует несколько размеров и миниатюр, используя Pillow для обработки изображений.